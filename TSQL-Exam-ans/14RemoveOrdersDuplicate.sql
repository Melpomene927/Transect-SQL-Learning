-- 刪除Z公司重覆的訂單資料

-- 取得 Z 公司所有訂單資料
SELECT * FROM ORDERS
WHERE COMPID='Z'
GO

-- 取得 Z 公司所有重覆的資料放入暫存資料表中, 並利用 RANK 自動編號欄位產生唯一的資料列
SELECT 
COMPID,
ORDERNO,
SNO,
ORDERDATE,
CUSTID,
PRODID,
QTY,
UPRICE,
AMOUNT,
ROW_NUMBER() OVER (PARTITION BY COMPID,ORDERNO,SNO ORDER BY SNO) [RANK]
INTO #TEMP
FROM ORDERS O
WHERE COMPID='Z'
AND EXISTS
(
	SELECT ORDERNO,SNO,COUNT(*) FROM ORDERS
	WHERE COMPID='Z'
	AND O.ORDERNO=ORDERS.ORDERNO
	AND O.SNO=ORDERS.SNO
	GROUP BY ORDERNO,SNO
	HAVING COUNT(*)>1
)
;

-- 刪除 ORDERS 資料表中所有重覆的資料
DELETE ORDERS 
FROM ORDERS O
WHERE EXISTS
(
	SELECT COMPID,ORDERNO,SNO FROM  #TEMP T
	WHERE O.COMPID=T.COMPID
	AND O.ORDERNO=T.ORDERNO
	AND O.SNO=T.SNO
	GROUP BY COMPID,ORDERNO,SNO
) 
;

-- 取得暫存資料表中 RANK = 1 的資料, 寫入  ORDERS 資料表
INSERT INTO ORDERS 
SELECT 
COMPID,
ORDERNO,
SNO,
ORDERDATE,
CUSTID,
PRODID,
QTY,
UPRICE,
AMOUNT
FROM #TEMP T
WHERE T.[RANK]=1
GO

-- 刪除暫存資料表
DROP TABLE #TEMP
GO

-- 取得 Z 公司所有訂單資料
SELECT * FROM ORDERS
WHERE COMPID='Z'
GO
